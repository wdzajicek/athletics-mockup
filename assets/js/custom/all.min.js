// DO NOT PLACE IN A DOCUMENT READY FUNTION - it will break

// Main Athletics carousel
$('.heroSlider').slick({
  dots: true,
  slidesToShow: 1,
  slidesToScroll: 1,
  autoplay: true,
  autoplaySpeed: 3000,
  prevArrow:'<img alt="" class="a-left control-c prev slick-prev" src="assets/img/dbl-prev.svg">',
  nextArrow:'<img alt="" class="a-right control-c next slick-next" src="assets/img/dbl-next.svg">'
});
// Baseball carousel
$('.baseballSlider').slick({
  dots: true,
  slidesToShow: 1,
  slidesToScroll: 1,
  autoplay: true,
  autoplaySpeed: 3000,
  prevArrow:'<img alt="" class="a-left control-c prev slick-prev" src="../../assets/img/dbl-prev.svg">',
  nextArrow:'<img alt="" class="a-right control-c next slick-next" src="../../assets/img/dbl-next.svg">'
});

// Custom JavaScript to pull in game schedule:
'use strict';
var Schedule = (function scheduleLoading() {
  var sortGames, team;
  var scheduletest = $('body').attr('data-sn');

  function init() {
    var urls ='https://spreadsheets.google.com/feeds/list/1Twj1SjoGY6H6tj3uwQ1MHMTLvaV2jV8MTvs40dSIvOI/' + scheduletest + '/public/values?alt=json';
    $.ajax({
      url:urls,
      dataType:'jsonp',
      data: {
        feed: 'entry'
      },
      success:function(data) {
        sortedSports(data.feed.entry);
      },
    });

  }

  function playing(player) {
    var gamePlayer;
    if(player.indexOf('at ') == -1 && player.indexOf('vs. ') == -1){
      gamePlayer = player;
    } else if (player.indexOf('at') >=0){
      gamePlayer = player.split('at ')[1];
    } else if (player.indexOf('vs') >=0){
      gamePlayer = player.split('vs. ')[1].split('@')[0];
    }
    return gamePlayer;
  }

  function HomeOrAway(opponent) {
    var locationColor, located;
    (opponent.indexOf('at ') >= 0 || opponent.indexOf('vs. ') >= 0 ) ? (locationColor = 'schedule-carousel__date-blue', located = opponent) : (locationColor = 'schedule-carousel__date-red', located = 'Home');
    return [locationColor, located];
  }

  function whereIsGame(at) {
    var located;
    if(at.indexOf('at ') == -1 && at.indexOf('@ ') == -1){
      located = 'Home';
    } else if (at.indexOf('at') >=0){
      located = at.split('at ')[1];
    } else if (at.indexOf('@') >=0){
      located = at.split('@ ')[1];
    }
    return [located];
  }

  function slickOptions(){
    $('.slick.games').slick({
      dots: false,
      autoplay: false,
      centerMode: false,
      slidesToShow: 3,
      slidesToScroll: 1,
      infinite: false,
      initialSlide: 0,
      arrows: true,
      buttons: true,
      prevArrow:'<img class="a-left control-c prev slick-prev" src="http://athletics.kcc.edu/assets/img/blue-prev.svg">',
      nextArrow:'<img class="a-right control-c next slick-next" src="http://athletics.kcc.edu/assets/img/blue-next.svg">',
      responsive: [
        {
          breakpoint: 1024,
          settings: {
            slidesToShow: 3,
            slidesToScroll: 3
          }
        },
        {
          breakpoint: 992,
          settings: {
            slidesToShow: 1,
            slidesToScroll: 1
          }
        },
      ]
    });
  }

  //Only list games as long as they have not been played
  //Sort each item returned by the date
  function sortedSports(sortGames){
    var d = new Date().toISOString(),
      months = [ 'Jan', 'Feb', 'March', 'April', 'May', 'June', 'July', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec' ],
      dateOfGame,
      slideString=[],
      slideStringLength;

    $.each(sortGames, function() {
      var that = this;
      dateOfGame = that.gsx$datecreated.$t;

      if(dateOfGame > d) { //If the entry's date is greater than the date then setup the track with a new div
        var arr = (dateOfGame).split('-'),
          opponent = that.gsx$vs.$t,
          scheduledGame = HomeOrAway(opponent),
          where = whereIsGame(opponent),
          ply = playing(opponent);
        slideString.push('<div class="slick slide"><div id="carousel_date" class="'+ scheduledGame[0] +'"><span class="schedule-carousel__date-month">'+months[-1+parseInt(arr[1],10)]+'</span><br><span class="schedule-carousel__date-day">'+arr[2].slice(0,2)+'</span></div><div><h3 class="schedule-carousel__sport"> ' + that.gsx$sport.$t + '</h3><p><span class="schedule-carousel__title">vs. ' + ply + '</span><br>'+ where +'<br><span class="schedule-carousel__time">'+ ((that.gsx$summary.$t).split('M: ')[0]).split('at ')[1] + '.M.<span></p></div></div>');
      }
    });

    slideStringLength = slideString.length;
    if(slideStringLength > 0 && slideStringLength <= 3) {
      document.querySelector('#track').innerHTML = slideString.join('');
      slickOptions();
      Youtube_carousel.init();
    } else if (slideStringLength === 0){
      document.querySelector('#track').innerHTML = '<p style="margin:10px;font-weight:bold;">Currently there are no upcoming games.</p>';
      Youtube_carousel.init();
    }
  }

  return {
    init: init
  };

})();

// Custom JavaScript to pull in YouTube playlist:
var Youtube_carousel = (function youtube_carousel_module(){

  var $apiK = $('meta[name=yt-api-k]').attr('value'),
    $ytList = $('#yt_list'),
    $ytPlayer = $('#yt_player');

  function init(){
    var default_user_name = 'KankakeeCommCollege';
    selectChannel(default_user_name);
  }

  function selectChannel(user_name) {
    $.ajax({
      url: 'https://www.googleapis.com/youtube/v3/channels',
      type: 'GET',
      dataType: 'json',
      data: {
        part: 'contentDetails',
        forUsername: user_name,
        key: $apiK
      },
      success: function (d) {
        $ytList.html('');
        if (d.pageInfo.totalResults > 0) {
          for (var _i = 0, _a = d.items; _i < _a.length; _i++) {
            var item = _a[_i];
            var uploads = 'PLEnNvZd4X-lVSveRGpbsXLCmf7hYXX97q';
            getVideos(uploads);
          }
        }
        else {
          $('input#user_name').addClass('error');
          $('div#channel_input > .info')
            .show()
            .html('This user not exists');
        }
      },
      error: function (x) {
        console.dir(x);
      }
    });
  }
  function getVideos(yt_id, next_page) {
    if (next_page === void 0) { next_page = ''; }
    var limit = 8;
    var more = '';
    var xhr = $.ajax({
      url: 'https://www.googleapis.com/youtube/v3/playlistItems',
      type: 'GET',
      dataType: 'json',
      data: {
        part: 'snippet',
        playlistId: yt_id,
        maxResults: limit,
        pageToken: next_page,
        key: $apiK
      },
      success: function (data) {
        if (data.nextPageToken) {
          more = '';
        }
        if (next_page === '') {
          $ytPlayer.attr('src', 'https://youtube.com/embed/' +
                    data.items[0].snippet.resourceId.videoId +
                    '?controls=0&showinfo=0&rel=0');
        }
        for (var i = 0; i < limit; i++) {
          var title = $('<h3 class="video-carousel__title">').append(data.items[i].snippet.title),
            thumb = $('<img class="img-fluid" src="assets/img/yt-loading.png">').attr('data-src', data.items[i].snippet.thumbnails.medium.url),
            video_id = data.items[i].snippet.resourceId.videoId,
            link = $('<a class="video-link" data-toggle="modal" data-target="#exampleModalCenter" href="#">')
              .data('videoid', video_id)
              .append(thumb),
            holder = $('<div class="item">').append(link, title);
          $ytList.append(holder);
        }
        $ytList.append(more);
        $ytList.slick({
          dots: false,
          infinite: false,
          autoplay: false,
          slidesToShow: 3,
          slidesToScroll: 1,
          adaptiveHeight: false,
          prevArrow:'<img class="a-left control-c prev slick-prev" src="http://athletics.kcc.edu/assets/img/blue-prev.svg">',
          nextArrow:'<img class="a-right control-c next slick-next" src="http://athletics.kcc.edu/assets/img/blue-next.svg">',
          responsive: [
            {
              breakpoint: 1024,
              settings: {
                slidesToShow: 3,
                slidesToScroll: 3
              }
            },
            {
              breakpoint: 992,
              settings: {
                slidesToShow: 1,
                slidesToScroll: 1
              }
            },
          ]
        });
        lzFunction();   // Lazy load function
      }
    });
  }
  /* load more */
  $ytList.on('click', '#load-more', function () {
    $(this)
      .animate({
        'transform': 'scaleX(4)',
        'opacity': '0.1'
      }, function () {
        var that = $(this);
        getVideos(that.data('yt-id'), that.data('next-page'));
        that.remove();
      });
  });
  /* embeds */
  $ytList.on('click', 'a.video-link', function () {
    var video_id = $(this).data('videoid');
    $ytPlayer.attr(
      'src',
      'https://youtube.com/embed/' +
      video_id +
      '?controls=0&showinfo=0&rel=0&autoplay=1'
    );
  });

  $('#exampleModalCenter').on('hide.bs.modal', function (e) {
    var video_id = $(this).data('videoid');
    var leg=$ytPlayer.attr(
      'src',
      'https://youtube.com/embed/' +
      video_id +
      '?controls=0&showinfo=0&rel=0&autoplay=0');
    $ytPlayer.attr('src',leg);
  });

  return {
    init: init
  };

})();

// GO GO GADGET SCHEDULE-SLIDER!
$(document).ready(function() {
  Schedule.init();
});

// Lazy load function
// ex. <img data-src="/path/to/image.jpg" alt="">
function lzFunction(){
  (function() {
    [].forEach.call(document.querySelectorAll('img[data-src]'), function(img) {
      img.setAttribute('src', img.getAttribute('data-src'));
      img.onload = function() {
        img.removeAttribute('data-src');
      };
    });
  })();
}
